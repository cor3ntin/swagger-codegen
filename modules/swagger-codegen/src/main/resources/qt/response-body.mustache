#include "AbstractResponse.h"
#include "ApiInvoker.h"
#include <QNetworkReply>
#include <QJsonDocument>
#include <QJsonValue>
#include <QJsonArray>
#include <QJsonObject>

namespace swagger {

AbstractRequest::AbstractRequest(AbstractApiInvoker::RequestParams && params, AbstractApiInvoker* invoker)
    : m_reply(nullptr)
    , m_params(params)
    , m_invoker(invoker) {

}

void AbstractRequest::send() {
    m_reply = m_invoker->invoke(m_params);
    if(!m_reply) {
        //WTF
    }
    connect(m_reply, &QNetworkReply::finished, this, &AbstractRequest::onReplyFinished);
}

AbstractRequest::~AbstractRequest() {
    m_reply->deleteLater();
}

quint16 AbstractRequest::status() const {
    if(!isFinished())
        return 0;
    return m_reply->attribute(QNetworkRequest::HttpStatusCodeAttribute).toInt();
}

quint32 AbstractRequest::duration() const {
    if(!isFinished())
        return 0;
    return m_reply->rawHeader("x-duration").toInt(); //returns 0 if fail
}

bool AbstractRequest::isFinished() const {
    return m_reply->isFinished();
}

bool AbstractRequest::success() const {
    auto s = status();
    return m_reply->error() == QNetworkReply::NoError
    && s >= 200 && s< 300;
}

void AbstractRequest::onReplyFinished() {
    bool hasError = false;
    QJsonDocument doc;
    if(m_reply->error() != QNetworkReply::NoError)
        hasError = true;
    else {
        QByteArray result = m_reply->readAll();
        QJsonParseError error;
        doc = QJsonDocument::fromJson(result, &error);
        if(error.error != QJsonParseError::NoError) {
            qWarning() << error.errorString();
            hasError = true;
        }
    }
    QJsonValue v;
    if(doc.isObject())
        v = doc.object();
    else if(doc.isArray())
        v = doc.array();

    if(!hasError && !v.isNull() && !v.isUndefined()) {
        bool handled = processResponse(status(), v);
        if(!handled) {
            //TODO
        }
    }
    else {
        //m_invoker->onError(this);
    }
    if(!parent())
        deleteLater();
}

}

